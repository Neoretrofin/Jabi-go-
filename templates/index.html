<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jabi Go üê∏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #eceff1; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; -webkit-tap-highlight-color: transparent; }
        
        .screen { display: none; width: 100%; height: 100%; align-items: center; justify-content: flex-start; flex-direction: column; overflow-y: auto; padding-bottom: 50px; }
        .active { display: flex; }
        h2 { color: #37474f; margin-top: 20px; text-align: center; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        #nav-bar { width: 95%; max-width: 1100px; display: none; justify-content: flex-end; padding: 10px 0; gap: 15px;}
        .nav-link { cursor: pointer; font-weight: bold; color: #546e7a; text-decoration: none; padding: 5px; }
        .nav-link:hover { color: #26a69a; }

        /* –õ–æ–≥–∏–Ω */
        #login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 300px; text-align: center; margin-top: 10vh; }
        input { padding: 10px; width: 90%; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { padding: 12px; width: 100%; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; color: white; transition: 0.2s; font-size: 16px; }
        .btn-green { background: #26a69a; } .btn-green:hover { background: #00897b; }
        .btn-blue { background: #42a5f5; } .btn-blue:hover { background: #1e88e5; }
        .btn-red { background: #ef5350; } .btn-red:hover { background: #e53935; }
        .btn-gray { background: #78909c; } .btn-gray:hover { background: #546e7a; }
        .btn-orange { background: #fb8c00; } .btn-orange:hover { background: #f57c00; }
        .login-note { font-size: 0.8em; color: #78909c; margin-top: 15px; }

        /* –õ–æ–±–±–∏ */
        #lobby-container { width: 95%; max-width: 1100px; display: flex; gap: 20px; margin-bottom: 20px; }
        .lobby-panel { background: white; flex: 1; border-radius: 8px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display:flex; flex-direction:column; overflow-x: auto; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 300px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.95em; white-space: nowrap; }
        th { color: #78909c; font-size: 0.85em; text-transform: uppercase; }
        .clickable-name { color: #1e88e5; cursor: pointer; font-weight: bold; }
        .clickable-row { cursor: pointer; transition: background 0.1s; border-left: 4px solid transparent; }
        .clickable-row:hover { background: #e3f2fd; }
        .row-win { border-left-color: #66bb6a; background: #e8f5e9; }
        .row-loss { border-left-color: #ef5350; background: #ffebee; }
        .status-lobby { color: #4caf50; font-weight: bold; }
        .status-playing { color: #ff9800; }
        .status-watching { color: #7e57c2; }
        .action-btn { padding: 4px 10px; font-size: 0.8em; width: auto; margin: 0; }
        .link-btn { background:none; border:none; color:#1e88e5; cursor:pointer; padding:0; text-decoration:underline; font-size:0.9em; width:auto; text-align:left;}

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        #screen-profile { justify-content: center; } 
        #profile-container { width: 95%; max-width: 800px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .profile-header { display: flex; gap: 30px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .avatar-box { width: 100px; height: 100px; border-radius: 4px; background: #eee; overflow: hidden; display: flex; justify-content: center; align-items: center; border: 2px solid #ddd; position: relative; flex-shrink: 0; }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
        .upload-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 0.7em; text-align: center; cursor: pointer; padding: 3px 0; display: none; }
        .avatar-box:hover .upload-label { display: block; }
        .stat-val { font-size: 1.2em; font-weight: bold; color: #37474f; }
        
        /* Leaderboard */
        #screen-leaderboard { justify-content: flex-start; padding-top: 20px; }
        #leaderboard-container { width: 95%; max-width: 900px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow-x: auto; }
        .lb-rank { font-weight: bold; color: #555; }
        .lb-avatar { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid #ccc; }
        .lb-win { color: #2e7d32; font-weight: bold; }
        .lb-loss { color: #c62828; font-weight: bold; }

        /* –ò–≥—Ä–∞ / –†–µ–ø–ª–µ–π (PC) */
        #game-layout { display: flex; gap: 20px; justify-content: center; width: 100%; max-width: 1100px; height: 700px; }
        #canvas-wrapper { position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-radius: 4px; background: #DCB35C; padding: 0; height: 700px; width: 700px; flex-shrink: 0; display:flex; flex-direction:column; }
        canvas { display: block; width: 700px; height: 700px; cursor: pointer; }

        #side-panel { width: 350px; display: flex; flex-direction: column; gap: 10px; height: 700px; flex: 1; overflow: hidden; }
        #info-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        #chat-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; flex: 1; min-height: 0; }
        #chat-msgs, #replay-chat { flex: 1; overflow-y: auto; border-bottom: 1px solid #eee; margin-bottom: 10px; font-size: 0.9em; word-wrap: break-word; }

        .players-container { display: flex; flex-direction: row; justify-content: space-around; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .player-block { display: flex; flex-direction: column; align-items: center; width: 45%; }
        .player-header-row { width: 100%; display: flex; justify-content: center; gap: 5px; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: #333; text-align:center; flex-wrap: wrap;}
        .big-avatar { width: 80px; height: 80px; border-radius: 6px; object-fit: cover; border: 2px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #eee; }
        .pris-label { font-size: 0.85em; color: #555; margin-top: 2px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .turn-indic { padding: 8px; text-align: center; border-radius: 4px; margin-bottom: 10px; font-weight: bold; background: #eee; color: #333; border: 1px solid #ddd;}
        .check-ok { color: #26a69a; font-weight: bold; margin-left: 5px; font-size: 1.2em; }
        
        .result-win { background-color: #e8f5e9 !important; color: #2e7d32; border: none; } 
        .result-loss { background-color: #ffebee !important; color: #c62828; border: none; } 

        .elo-msg { text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 0.9em; }
        .elo-msg-win { color: #2e7d32; }
        .elo-msg-loss { color: #c62828; }

        /* Chat Row Flex */
        .chat-row { display: flex; margin-bottom: 4px; align-items: flex-start; }
        .chat-meta { white-space: nowrap; display: flex; align-items: center; margin-right: 5px; }

        .stone-icon { width: 12px; height: 12px; border-radius: 50%; display: inline-block; flex-shrink: 0; margin-right: 5px; }
        .stone-icon.black { background: #000; border: 1px solid #000; }
        .stone-icon.white { background: #fff; border: 1px solid #ccc; }
        .stone-icon.spec { background: #ccc; border: 1px solid #999; }
        
        #sound-control { margin-top: 10px; font-size: 0.8em; color: #666; display: flex; align-items: center; gap: 5px; }
        #vol-slider { flex: 1; cursor: pointer; }

        #user-tooltip { display: none; position: fixed; background: white; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-shadow: 0 5px 10px rgba(0,0,0,0.2); z-index: 2000; font-size: 0.9em; pointer-events: none; }
        .tooltip-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 10px; }
        .tooltip-content { display: flex; align-items: center; }

        #modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 8px; text-align: center; width: 90%; max-width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-btn-row { display:flex; gap:10px; margin-top:20px; justify-content:center; }
        
        #global-return-btn { position: fixed; bottom: 20px; left: 20px; z-index: 3000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 12px 25px; font-size: 1em; border-radius: 30px; }
        
        #confirm-move-btn { display:none; width: 100%; padding: 15px; font-size: 1.1em; margin-bottom: 10px; background: #26a69a; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* Replay Header Layout */
        .replay-header { margin-bottom:10px; width:100%; max-width:900px; position: relative; display: flex; align-items: center; justify-content: center; min-height: 40px; }
        .replay-back-btn { position: absolute; left: 0; width:auto; padding:8px 20px; }
        .replay-title-text { font-weight:bold; font-size:1.3em; color:#37474f; text-align: center; }

        /* PC Move Count (under board) */
        #pc-move-count { margin-top: 5px; text-align: center; font-size: 0.9em; color: #555; }
        #mobile-move-count { text-align:center; font-size:0.85em; color:#777; margin-bottom:10px; display: none; }

        /* --- MEDIA QUERIES FOR MOBILE --- */
        @media (max-width: 900px) {
            #lobby-container { flex-direction: column; }
            #game-layout { flex-direction: column; align-items: center; height: auto; }
            
            #canvas-wrapper { width: 100%; max-width: 600px; height: auto; order: 1; display:flex; justify-content:center; aspect-ratio: 1/1; margin-bottom: 10px; }
            canvas { width: 100% !important; height: 100% !important; }
            
            #confirm-move-btn { order: 2; width: 95%; max-width: 600px; margin: 0 auto 10px auto; }
            #side-panel { width: 100%; max-width: 600px; order: 3; height: auto; overflow: visible; }
            
            #nav-bar { justify-content: center; }
            .nav-link { font-size: 0.9em; }
            
            h2 { font-size: 1.5em; }
            .big-avatar { width: 60px; height: 60px; }
            
            #global-return-btn { bottom: 10px; left: 50%; transform: translateX(-50%); width: 80%; text-align: center; }
            
            #chat-box { min-height: 300px; } 
            
            .replay-header { flex-direction: column; gap: 10px; }
            .replay-back-btn { position: static; width: 100%; }

            #pc-move-count { display: none; }
            #mobile-move-count { display: block; }
        }
    </style>
</head>
<body>

    <button id="global-return-btn" class="btn-orange" onclick="rejoinGame()">‚ö° –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É</button>

    <div id="user-tooltip"></div>

    <!-- Generic Modals -->
    <div id="modal-overlay">
        <!-- Color Pick -->
        <div id="modal-setup" class="modal-box" style="display:none;">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</h3>
            <p>–í–∞—à–∞ –ø–∞—Ä—Ç–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è. –ó–∞ –∫–æ–≥–æ –±—É–¥–µ—Ç–µ –∏–≥—Ä–∞—Ç—å?</p>
            <div class="modal-btn-row">
                <button class="btn-green" style="background:#000; border:1px solid #555;" onclick="pickColor(1)">–ß—ë—Ä–Ω—ã–µ</button>
                <button class="btn-green" style="background:#fff; color:#000; border:1px solid #ccc;" onclick="pickColor(2)">–ë–µ–ª—ã–µ</button>
            </div>
        </div>
        <!-- Challenge -->
        <div id="modal-challenge" class="modal-box" style="display:none;">
            <h3>–í–∞—Å –≤—ã–∑—ã–≤–∞–µ—Ç!</h3>
            <p id="challenge-text"></p>
            <div class="modal-btn-row">
                <button class="btn-green" onclick="respondChallenge(true)">–ü—Ä–∏–Ω—è—Ç—å</button>
                <button class="btn-red" onclick="respondChallenge(false)">–û—Ç–∫–∞–∑–∞—Ç—å</button>
            </div>
        </div>
        <!-- Undo -->
        <div id="modal-undo" class="modal-box" style="display:none;">
            <h3>–ó–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—Ç–∞</h3>
            <p id="undo-text"></p>
            <div class="modal-btn-row">
                <button class="btn-green" onclick="respondUndo(true)">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
                <button class="btn-red" onclick="respondUndo(false)">–û—Ç–∫–∞–∑–∞—Ç—å</button>
            </div>
        </div>
        <!-- Generic Alert -->
        <div id="modal-alert" class="modal-box" style="display:none;">
            <h3 id="alert-title">–í–Ω–∏–º–∞–Ω–∏–µ</h3>
            <p id="alert-text"></p>
            <div class="modal-btn-row">
                <button class="btn-blue" onclick="closeModal()">OK</button>
            </div>
        </div>
        <!-- Generic Confirm -->
        <div id="modal-confirm" class="modal-box" style="display:none;">
            <h3 id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <p id="confirm-text"></p>
            <div class="modal-btn-row">
                <button class="btn-green" id="confirm-yes-btn">–î–∞</button>
                <button class="btn-red" onclick="closeModal()">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <div id="nav-bar">
        <span class="nav-link" onclick="showScreen('screen-lobby')">–õ–æ–±–±–∏</span>
        <span class="nav-link" onclick="openProfile()">–ü—Ä–æ—Ñ–∏–ª—å</span>
        <span class="nav-link" onclick="openLeaderboard()">–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</span>
        <span class="nav-link" onclick="logout()" style="color:#ef5350;">–í—ã—Ö–æ–¥</span>
    </div>

    <div id="screen-login" class="screen active">
        <div id="login-box">
            <h2>Jabi Go üê∏</h2>
            <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-green" onclick="login()">–í–æ–π—Ç–∏</button>
            <div id="login-msg" style="color:red; margin-top:10px; font-size:0.9em;"></div>
            <div class="login-note">‚ö† –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –∞–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div style="width: 95%; max-width: 1100px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
            <h2>–õ–æ–±–±–∏</h2>
            <div style="margin-top:10px;">–ü—Ä–∏–≤–µ—Ç, <b id="my-username">User</b> (Elo: <span id="my-elo">1000</span>)</div>
        </div>
        <div id="lobby-rejoin-area" style="width: 95%; max-width: 1100px; margin-bottom: 10px; display:none;">
            <button class="btn-orange" onclick="rejoinGame()">‚ö° –í–ï–†–ù–£–¢–¨–°–Ø –ö –ü–ê–†–¢–ò–ò</button>
        </div>
        <div id="lobby-container">
            <div class="lobby-panel">
                <h3>–ò–≥—Ä–æ–∫–∏ –æ–Ω–ª–∞–π–Ω</h3>
                <table><thead><tr><th>–ò–º—è</th><th>Elo</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead><tbody id="user-table"></tbody></table>
            </div>
            <div class="lobby-panel">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏</h3>
                <div style="flex:1; overflow-y:auto; min-height: 150px; border-bottom:1px solid #eee;">
                    <table><thead><tr><th>–ú–∞—Ç—á</th><th>–ó—Ä–∏—Ç–µ–ª–∏</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead><tbody id="game-table"></tbody></table>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                    <h3 style="margin:0;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</h3>
                    <button class="btn-blue" style="width:auto; padding:5px 10px; font-size:0.9em;" onclick="openFullHistory()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                </div>
                <div style="flex:1; overflow-y:auto;">
                    <table><thead><tr><th>–ß—ë—Ä–Ω—ã–µ</th><th>–ë–µ–ª—ã–µ</th><th>–†–µ–∑</th><th>–î–∞—Ç–∞</th></tr></thead><tbody id="finished-table"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div id="profile-container">
            <div id="profile-rejoin-area" style="margin-bottom: 15px; display:none;">
                <button class="btn-orange" onclick="rejoinGame()">‚ö° –í–ï–†–ù–£–¢–¨–°–Ø –ö –ü–ê–†–¢–ò–ò</button>
            </div>
            <div class="profile-header">
                <div class="avatar-box">
                    <img id="profile-avatar-img" src="">
                    <label id="upload-btn-label" class="upload-label" for="avatar-input">–ó–∞–≥—Ä—É–∑–∏—Ç—å</label>
                    <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="uploadAvatar()">
                </div>
                <div style="text-align:center;">
                    <h2 id="profile-name" style="margin:0 0 5px 0;">User</h2>
                    <div style="color:#666;">Elo: <span id="profile-elo" class="stat-val">1000</span></div>
                    <div style="font-size:0.9em; margin-top:5px;">–ü–æ–±–µ–¥: <b id="profile-wins">0</b> / –ü–æ—Ä–∞–∂–µ–Ω–∏–π: <b id="profile-losses">0</b></div>
                </div>
            </div>
            <h3>–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h3>
            <div style="max-height: 400px; overflow-y: auto;">
                <table>
                    <thead><tr><th>–î–∞—Ç–∞</th><th>–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</th><th>–¶–≤–µ—Ç</th><th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th><th>Elo</th></tr></thead>
                    <tbody id="profile-history-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <div style="width: 95%; max-width: 900px; margin-bottom:10px;">
            <h2>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
        </div>
        <div id="leaderboard-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:50px;">#</th>
                        <th>–ò–≥—Ä–æ–∫</th>
                        <th>–ü–æ–±–µ–¥ / –ü–æ—Ä–∞–∂–µ–Ω–∏–π</th>
                        <th>–í—Å–µ–≥–æ –∏–≥—Ä</th>
                        <th>ELO</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-table"></tbody>
            </table>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div style="margin-bottom:10px; width:100%; max-width:900px; display:flex; align-items:center; justify-content:space-between;">
            <button class="btn-red" style="width:auto; padding:8px 20px;" onclick="leaveGame()">‚óÄ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –õ–æ–±–±–∏</button>
            <!-- Game Title Hidden in Active Game -->
            <span id="game-title" style="font-weight:bold; color:#555; text-align:right; display:none;"></span>
        </div>
        <div id="game-layout">
            <div id="canvas-wrapper">
                <canvas id="goBoard" width="700" height="700"></canvas>
                <!-- PC Move Count -->
                <div id="pc-move-count">–•–æ–¥: 0</div>
            </div>
            
            <!-- Mobile Confirm Button -->
            <button id="confirm-move-btn" onclick="submitMobileMove()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ö–æ–¥</button>

            <div id="side-panel">
                <div id="info-box">
                    <div id="turn-display" class="turn-indic">–•–æ–¥...</div>
                    <!-- Mobile Move Count -->
                    <div id="mobile-move-count">–•–æ–¥ ‚Ññ0</div>
                    
                    <div class="players-container">
                        <div class="player-block">
                            <div class="player-header-row">
                                <span class="clickable-name" onclick="openProfile(this.innerText)" onmousemove="showTooltip(event, this.innerText)" onmouseleave="hideTooltip()">...</span>
                                <span id="check-b"></span>
                            </div>
                            <img id="av-b" class="big-avatar" src="">
                            <div class="pris-label">
                                <div class="stone-icon black"></div> (–ü–ª–µ–Ω: <b id="pris-b">0</b>)
                            </div>
                        </div>
                        <div class="player-block">
                            <div class="player-header-row">
                                <span class="clickable-name" onclick="openProfile(this.innerText)" onmousemove="showTooltip(event, this.innerText)" onmouseleave="hideTooltip()">...</span>
                                <span id="check-w"></span>
                            </div>
                            <img id="av-w" class="big-avatar" src="">
                            <div class="pris-label">
                                <div class="stone-icon white"></div> (–ü–ª–µ–Ω: <b id="pris-w">0</b>)
                            </div>
                        </div>
                    </div>
                    
                    <div style="font-size:0.8em; color:#666; text-align:center;">Komi: 6.5</div>

                    <div id="play-btns" style="margin-top:10px;">
                        <button class="btn-blue" onclick="sendPass()">–ü–∞—Å</button>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button class="btn-blue" style="background:#ffb74d" onclick="requestUndo()">–í–µ—Ä–Ω—É—Ç—å —Ö–æ–¥</button>
                            <button class="btn-red" onclick="sendResign()">–°–¥–∞—Ç—å—Å—è</button>
                        </div>
                    </div>
                    
                    <!-- Immediate Replay Controls -->
                    <div id="immediate-replay-box" style="display:none; text-align:center; margin-top:10px;">
                        <div style="font-size:0.9em; font-weight:bold; margin-bottom:5px;">–û–±–∑–æ—Ä –ø–∞—Ä—Ç–∏–∏</div>
                        <div style="display:flex; gap:5px; justify-content:center;">
                            <button class="btn-gray" style="padding:5px 10px;" onclick="stepActiveReview(-999)">Start</button>
                            <button class="btn-blue" style="padding:5px 10px;" onclick="stepActiveReview(-1)">Prev</button>
                            <button class="btn-blue" style="padding:5px 10px;" onclick="stepActiveReview(1)">Next</button>
                            <button class="btn-gray" style="padding:5px 10px;" onclick="stepActiveReview(999)">End</button>
                        </div>
                    </div>

                    <div id="score-btns" style="display:none; margin-top:10px;">
                        <div style="font-size:0.8em; color:red; margin-bottom:5px; text-align:center;">–û—Ç–º–µ—Ç—å—Ç–µ –º—ë—Ä—Ç–≤—ã–µ –∫–∞–º–Ω–∏</div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-green" onclick="confirmScore()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                            <button class="btn-blue" onclick="resumeGame()">–î–æ–∏–≥—Ä–∞—Ç—å</button>
                        </div>
                    </div>
                    
                    <div id="download-sgf-area" style="display:none; margin-top:10px;">
                         <button class="btn-gray" onclick="downloadSGF()">üíæ –°–∫–∞—á–∞—Ç—å SGF</button>
                    </div>

                    <div id="wait-msg" style="display:none; color:#78909c; text-align:center; margin-top:10px;">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                    <div id="elo-msg-box" class="elo-msg"></div>

                    <div id="sound-control">
                        <span id="vol-icon">üîä</span>
                        <input type="range" id="vol-slider" min="0" max="1" step="0.01" value="0.1">
                    </div>
                    <div id="scoring-details" style="display:none; margin-top:10px; border-top:1px solid #eee; padding-top:5px; font-size:0.85em;"></div>
                </div>
                <div id="chat-box">
                    <div id="chat-msgs"></div>
                    <input type="text" id="chat-input" placeholder="–ß–∞—Ç..." onkeypress="if(event.key==='Enter') sendChat()">
                </div>
            </div>
        </div>
    </div>

    <div id="screen-history" class="screen">
        <div style="width: 95%; max-width: 900px; display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
            <button class="btn-gray" style="width:auto; padding:8px 20px;" onclick="showScreen('screen-lobby')">‚óÄ –ù–∞–∑–∞–¥</button>
        </div>
        <div style="width: 95%; max-width: 900px; background: white; border-radius: 8px; padding: 20px; flex:1; overflow-y: auto;">
            <table>
                <thead><tr><th>–î–∞—Ç–∞</th><th>–ò–≥—Ä–æ–∫–∏</th><th>–†–µ–∑</th></tr></thead>
                <tbody id="full-history-table"></tbody>
            </table>
        </div>
    </div>

    <div id="screen-replay" class="screen">
        <div class="replay-header">
            <button class="btn-red replay-back-btn" onclick="exitReplay()">‚óÄ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –õ–æ–±–±–∏</button>
            <div id="replay-title" class="replay-title-text"></div>
        </div>

        <div id="game-layout">
            <div id="canvas-wrapper">
                <canvas id="replayBoard" width="700" height="700"></canvas>
            </div>
            <div id="side-panel">
                <div id="info-box">
                    <div class="players-container">
                         <div class="player-block">
                            <div class="player-header-row">
                                <span class="clickable-name" id="rep-name-b">...</span>
                            </div>
                            <img id="rep-av-b" class="big-avatar" src="">
                            <div class="pris-label">
                                <div class="stone-icon black"></div> (–ü–ª–µ–Ω: <span id="rep-pris-b">?</span>)
                            </div>
                        </div>
                        <div class="player-block">
                            <div class="player-header-row">
                                <span class="clickable-name" id="rep-name-w">...</span>
                            </div>
                            <img id="rep-av-w" class="big-avatar" src="">
                            <div class="pris-label">
                                <div class="stone-icon white"></div> (–ü–ª–µ–Ω: <span id="rep-pris-w">?</span>)
                            </div>
                        </div>
                    </div>

                    <div style="text-align:center; margin-bottom:10px;"><b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</b></div>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <button class="btn-gray" onclick="replayStep(-999)">Start</button>
                        <button class="btn-blue" onclick="replayStep(-1)">Prev</button>
                        <button class="btn-blue" onclick="replayStep(1)">Next</button>
                        <button class="btn-gray" onclick="replayStep(999)">End</button>
                    </div>
                    <div id="replay-info" style="text-align:center; margin-top:10px; font-size:0.9em; color:#555;">–•–æ–¥: 0</div>
                    <button class="btn-gray" style="margin-top:10px;" onclick="downloadSGFReplay()">üíæ –°–∫–∞—á–∞—Ç—å SGF</button>
                </div>
                <div id="chat-box">
                    <div id="replay-chat"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- FORCE WEBSOCKETS TO PREVENT LAG ---
    const socket = io({
        transports: ['websocket'], 
        upgrade: false
    });
    
    let myRole = 0; 
    let gameState = null; 
    let replayData = null; 
    let replayIndex = 0;
    let prevLastMove = null;
    let lobbyUsersMap = {}; 
    let hoverStone = null; 
    let prevPasses = 0;
    let amIPlaying = false; 
    
    // Mobile Move Logic
    let tentativeMove = null; 
    
    // Immediate Review
    let activeReviewIndex = -1;
    
    // Move Debounce
    let isProcessingMove = false;

    const moveSound = new Audio('/stone.mp3');
    const dingSound = new Audio('/ding.mp3');
    const eatSound = new Audio('/eat.mp3'); 
    
    moveSound.volume = 0.1;
    dingSound.volume = 0.1;
    eatSound.volume = 0.1;
    
    document.getElementById('vol-slider').value = 0.1;

    document.getElementById('vol-slider').addEventListener('input', (e) => {
        let v = parseFloat(e.target.value);
        moveSound.volume = v;
        dingSound.volume = v;
        eatSound.volume = v;
        document.getElementById('vol-icon').innerText = (v === 0) ? 'üîá' : 'üîä';
    });
    
    // --- KEEP ALIVE ---
    setInterval(() => {
        fetch('/keep_alive').catch(e => {});
    }, 4 * 60 * 1000);

    const BOARD_SIZE = 13, CELL_SIZE = 50, PADDING = 50;
    const liveCanvas = document.getElementById('goBoard');
    const liveCtx = liveCanvas.getContext('2d');
    const replayCanvas = document.getElementById('replayBoard');
    const replayCtx = replayCanvas.getContext('2d');
    
    const DEF_AVATAR = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1zaXplPSI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IiNjY2MiPj88L3RleHQ+PC9zdmc+";

    function isMobile() {
        return window.innerWidth <= 900;
    }

    function formatTimeLocal(isoStr) {
        if (!isoStr) return "";
        const d = new Date(isoStr);
        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // --- FORMAT DATE HELPER ---
    function formatDateShort(isoStr) {
        if (!isoStr) return "";
        const d = new Date(isoStr);
        const day = d.getDate().toString().padStart(2, '0');
        const month = (d.getMonth() + 1).toString().padStart(2, '0');
        const year = d.getFullYear().toString().slice(-2);
        return `${day}.${month}.${year}`;
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id !== 'screen-login') document.getElementById('nav-bar').style.display = 'flex';
        
        // -- FIX BUTTON VISIBILITY GLOBALLY --
        const btn = document.getElementById('global-return-btn');
        if (amIPlaying && id !== 'screen-game') {
             btn.style.display = 'block';
        } else {
             btn.style.display = 'none';
        }

        if (id === 'screen-lobby') {
            socket.emit('refresh_lobby');
        }
    }
    
    // --- CUSTOM MODALS ---
    function showAlert(text, title="–í–Ω–∏–º–∞–Ω–∏–µ") {
        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-text').innerText = text;
        openModal('modal-alert');
    }

    function showConfirm(text, callback) {
        document.getElementById('confirm-title').innerText = "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ";
        document.getElementById('confirm-text').innerText = text;
        const yesBtn = document.getElementById('confirm-yes-btn');
        const newBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newBtn, yesBtn);
        newBtn.onclick = () => { closeModal(); callback(); };
        openModal('modal-confirm');
    }

    function openModal(id) { 
        document.getElementById('modal-overlay').style.display='flex';
        document.querySelectorAll('.modal-box').forEach(b=>b.style.display='none');
        document.getElementById(id).style.display='block';
    }
    function closeModal() { document.getElementById('modal-overlay').style.display='none'; }

    function login() { 
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        localStorage.setItem('go_username', u);
        localStorage.setItem('go_password', p);
        socket.emit('login', {username: u, password: p}); 
    }
    
    function logout() {
        localStorage.removeItem('go_username');
        localStorage.removeItem('go_password');
        location.reload();
    }

    function rejoinGame() {
        const u = localStorage.getItem('go_username');
        const p = localStorage.getItem('go_password');
        if(u && p) socket.emit('login', {username: u, password: p});
    }
    
    socket.on('login_error', d => document.getElementById('login-msg').innerText = d.msg);
    socket.on('login_success', d => {
        document.getElementById('my-username').innerText = d.username;
        document.getElementById('my-elo').innerText = d.elo;
        showScreen('screen-lobby');
    });
    
    // --- RE-SYNC ON RECONNECT/VISIBILITY ---
    socket.on('connect', () => {
         const u = localStorage.getItem('go_username');
         const p = localStorage.getItem('go_password');
         if(u && p) socket.emit('login', {username: u, password: p});
         
         if (gameState && gameState.id) {
             socket.emit('request_sync', {game_id: gameState.id});
         }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && gameState && gameState.id) {
             socket.emit('request_sync', {game_id: gameState.id});
        }
    });

    // --- TOOLTIP ---
    function showTooltip(e, username) {
        if(isMobile()) return;
        const u = lobbyUsersMap[username];
        if (u) {
            renderTooltip(e, u);
        } else {
            socket.emit('get_tooltip_data', {username: username});
            window.lastTooltipEvent = e; 
        }
    }
    
    socket.on('tooltip_data_response', u => {
        if (window.lastTooltipEvent) {
            renderTooltip(window.lastTooltipEvent, u);
        }
    });

    function renderTooltip(e, u) {
        const tt = document.getElementById('user-tooltip');
        const av = u.avatar || DEF_AVATAR;
        tt.innerHTML = `
            <div class="tooltip-content">
                <img src="${av}" class="tooltip-img">
                <div>
                    <b>${u.username}</b><br>
                    Elo: ${u.elo}<br>
                    <span style="color:#2e7d32">W: ${u.wins}</span> / <span style="color:#c62828">L: ${u.losses}</span>
                </div>
            </div>
        `;
        tt.style.display = 'block';
        moveTooltip(e);
    }

    function moveTooltip(e) {
        const tt = document.getElementById('user-tooltip');
        tt.style.left = (e.clientX + 15) + 'px';
        tt.style.top = (e.clientY + 15) + 'px';
    }
    function hideTooltip() {
        document.getElementById('user-tooltip').style.display = 'none';
        window.lastTooltipEvent = null;
    }

    socket.on('lobby_update', d => {
        const ut = document.getElementById('user-table'); ut.innerHTML = '';
        lobbyUsersMap = {};
        
        const myName = document.getElementById('my-username').innerText;
        amIPlaying = false;

        d.users.forEach(u => {
            lobbyUsersMap[u.username] = u;
            if(u.username === myName && u.status === 'playing') amIPlaying = true;

            let canChallenge = (u.username !== myName && (u.status === 'lobby' || u.status === 'watching'));
            let act = canChallenge 
                ? `<button class="action-btn btn-green" onclick="sendChallenge('${u.sid}')">–í—ã–∑–≤–∞—Ç—å</button>` : '';
            
            if(u.status==='playing') act='<span style="color:#999;font-size:0.8em">–ò–≥—Ä–∞–µ—Ç</span>';
            
            ut.innerHTML += `<tr>
                <td><span class="clickable-name" onclick="openProfile('${u.username}')" onmousemove="showTooltip(event, '${u.username}')" onmouseleave="hideTooltip()">${u.username}</span></td>
                <td>${u.elo}</td>
                <td class="status-${u.status}">${u.status}</td>
                <td>${act}</td>
            </tr>`;
        });
        
        // Force button check in case we are already on a screen
        const btn = document.getElementById('global-return-btn');
        if (amIPlaying && !document.getElementById('screen-game').classList.contains('active')) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }

        const gt = document.getElementById('game-table'); gt.innerHTML = '';
        d.games.forEach(g => {
            let actionBtn = `<button class="action-btn btn-blue" onclick="spectate('${g.id}')">–°–º–æ—Ç—Ä–µ—Ç—å</button>`;
            if(g.p1 === myName || g.p2 === myName) {
                actionBtn = `<button class="action-btn btn-orange" onclick="rejoinGame()">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>`;
            }

            gt.innerHTML += `<tr>
                <td><span class="clickable-name" onclick="openProfile('${g.p1}')" onmousemove="showTooltip(event, '${g.p1}')" onmouseleave="hideTooltip()">${g.p1}</span> vs <span class="clickable-name" onclick="openProfile('${g.p2}')" onmousemove="showTooltip(event, '${g.p2}')" onmouseleave="hideTooltip()">${g.p2}</span></td>
                <td>${g.spectators}</td>
                <td>${actionBtn}</td>
            </tr>`;
        });
        
        const ft = document.getElementById('finished-table'); ft.innerHTML = '';
        d.finished.forEach(g => {
            let p1Name = g.p_black + (g.winner_color === 1 ? ' üèÜ' : '');
            let p2Name = g.p_white + (g.winner_color === 2 ? ' üèÜ' : '');
            let shortDate = formatDateShort(g.date);

            ft.innerHTML += `<tr class="clickable-row" onclick="loadReplay(${g.id})">
                <td><span class="clickable-name" onclick="event.stopPropagation(); openProfile('${g.p_black}')" onmousemove="showTooltip(event, '${g.p_black}')" onmouseleave="hideTooltip()">${p1Name}</span></td>
                <td><span class="clickable-name" onclick="event.stopPropagation(); openProfile('${g.p_white}')" onmousemove="showTooltip(event, '${g.p_white}')" onmouseleave="hideTooltip()">${p2Name}</span></td>
                <td><b>${g.result}</b></td>
                <td style="font-size:0.9em; color:#666;">${shortDate}</td>
            </tr>`;
        });
    });

    // --- LEADERBOARD ---
    function openLeaderboard() {
        socket.emit('get_leaderboard');
        showScreen('screen-leaderboard');
    }
    socket.on('leaderboard_data', data => {
        const tb = document.getElementById('leaderboard-table'); tb.innerHTML = '';
        data.forEach((u, idx) => {
            let rank = idx + 1;
            let av = u.avatar || DEF_AVATAR;
            tb.innerHTML += `<tr class="clickable-row" onclick="openProfile('${u.username}')">
                <td class="lb-rank">${rank}</td>
                <td>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${av}" class="lb-avatar">
                        <span class="clickable-name" onclick="event.stopPropagation(); openProfile('${u.username}')">${u.username}</span>
                    </div>
                </td>
                <td><span class="lb-win">${u.wins}</span> / <span class="lb-loss">${u.losses}</span></td>
                <td>${u.total}</td>
                <td style="font-weight:bold;">${u.elo}</td>
            </tr>`;
        });
    });

    // --- PROFILE ---
    function openProfile(targetUser) {
        if(!targetUser) targetUser = document.getElementById('my-username').innerText;
        socket.emit('get_profile', {username: targetUser});
        showScreen('screen-profile');
    }
    socket.on('profile_data', d => {
        document.getElementById('profile-name').innerText = d.username;
        document.getElementById('profile-elo').innerText = d.elo;
        document.getElementById('profile-wins').innerText = d.wins;
        document.getElementById('profile-losses').innerText = d.losses;
        document.getElementById('profile-avatar-img').src = d.avatar || DEF_AVATAR;
        document.getElementById('upload-btn-label').style.display = d.is_own ? 'block' : 'none';

        const tb = document.getElementById('profile-history-table'); tb.innerHTML = '';
        d.history.forEach(h => {
            const dateStr = new Date(h.date).toLocaleDateString();
            const eloText = h.elo_diff > 0 ? `+${h.elo_diff}` : h.elo_diff;
            const rowClass = h.is_win ? 'row-win' : 'row-loss';
            tb.innerHTML += `<tr class="clickable-row ${rowClass}" onclick="loadReplay(${h.game_id})">
                <td>${dateStr}</td>
                <td>${h.opponent}</td>
                <td>${h.my_color===1 ? '–ß' : '–ë'}</td>
                <td>${h.result}</td>
                <td style="font-weight:bold;">${eloText}</td>
            </tr>`;
        });
    });

    function uploadAvatar() {
        const file = document.getElementById('avatar-input').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const cvs = document.createElement('canvas');
                cvs.width = 100; cvs.height = 100;
                const ctx = cvs.getContext('2d');
                ctx.drawImage(img, 0, 0, 100, 100);
                const base64 = cvs.toDataURL('image/jpeg', 0.8);
                socket.emit('upload_avatar', {image: base64});
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }
    socket.on('server_notification', d => showAlert(d.msg));

    function openFullHistory() {
        socket.emit('get_all_history');
        showScreen('screen-history');
    }
    socket.on('history_list', list => {
        const t = document.getElementById('full-history-table'); t.innerHTML = '';
        list.forEach(g => {
            const localTime = formatTimeLocal(g.date);
            const fullDate = new Date(g.date).toLocaleDateString() + ' ' + localTime;
            
            let p1Name = g.p_black + (g.winner_color === 1 ? ' üèÜ' : '');
            let p2Name = g.p_white + (g.winner_color === 2 ? ' üèÜ' : '');

            t.innerHTML += `<tr class="clickable-row" onclick="loadReplay(${g.id})">
                <td title="${fullDate}">${new Date(g.date).toLocaleDateString()} ${localTime}</td>
                <td><span class="clickable-name" onclick="event.stopPropagation(); openProfile('${g.p_black}')" onmousemove="showTooltip(event, '${g.p_black}')" onmouseleave="hideTooltip()">${p1Name}</span> vs <span class="clickable-name" onclick="event.stopPropagation(); openProfile('${g.p_white}')" onmousemove="showTooltip(event, '${g.p_white}')" onmouseleave="hideTooltip()">${p2Name}</span></td>
                <td><b>${g.result}</b></td>
            </tr>`;
        });
    });

    // --- REPLAY ---
    function loadReplay(id) {
        socket.emit('get_replay_data', {record_id: id});
    }
    socket.on('replay_data', d => {
        replayData = d;
        replayIndex = d.states.length > 0 ? d.states.length - 1 : 0;
        let fmtResult = d.result.replace(' (', ', ').replace(')', '');
        
        let p1Name = d.p_black;
        let p2Name = d.p_white;
        
        if (d.winner_color === 1) p1Name += ' üèÜ';
        if (d.winner_color === 2) p2Name += ' üèÜ';

        document.getElementById('replay-title').innerText = `${p1Name} vs ${p2Name} (${fmtResult})`;
        
        const nB = document.getElementById('rep-name-b');
        nB.innerText = p1Name;
        nB.onclick = () => openProfile(d.p_black); 
        nB.onmousemove = (e) => showTooltip(e, d.p_black);
        nB.onmouseleave = () => hideTooltip();

        const nW = document.getElementById('rep-name-w');
        nW.innerText = p2Name;
        nW.onclick = () => openProfile(d.p_white);
        nW.onmousemove = (e) => showTooltip(e, d.p_white);
        nW.onmouseleave = () => hideTooltip();

        document.getElementById('rep-av-b').src = d.av_black || DEF_AVATAR;
        document.getElementById('rep-av-w').src = d.av_white || DEF_AVATAR;

        renderReplay();
        renderReplayChat();
        showScreen('screen-replay');
    });
    
    function downloadSGFReplay() {
        if(replayData) window.location.href = `/download_sgf/${replayData.id}`;
    }

    function replayStep(delta) {
        if (!replayData) return;
        replayIndex += delta;
        if (replayIndex < 0) replayIndex = 0;
        if (replayIndex >= replayData.states.length) replayIndex = replayData.states.length - 1;
        renderReplay();
    }
    
    function renderReplay() {
        const state = replayData.states[replayIndex];
        document.getElementById('replay-info').innerText = `–•–æ–¥ ${replayIndex} / ${replayData.states.length - 1}`;
        document.getElementById('rep-pris-b').innerText = state.prisoners[1];
        document.getElementById('rep-pris-w').innerText = state.prisoners[2];
        drawGenericBoard(replayCtx, state, null);
    }
    
    function renderReplayChat() {
        const box = document.getElementById('replay-chat'); box.innerHTML = '';
        if(replayData && replayData.chat) {
            replayData.chat.forEach(m => {
                 let iconClass = m.color === 1 ? "stone-icon black" : (m.color === 2 ? "stone-icon white" : "stone-icon spec");
                 let moveInfo = (m.move !== undefined) ? `<span style="color:#999; font-size:0.8em; margin-right:4px;">[${m.move}]</span>` : '';
                 
                 box.innerHTML += `
                 <div class="chat-row">
                    <span class="chat-meta">
                        ${moveInfo}
                        <div class="${iconClass}"></div>
                        <b>${m.user}: </b>
                    </span>
                    <span>${m.text}</span>
                 </div>`;
            });
        }
        box.scrollTop = box.scrollHeight;
    }
    
    function exitReplay() { 
        socket.emit('leave_game'); 
        showScreen('screen-lobby'); 
        replayData = null; 
    }

    // --- GAME ---
    function sendChallenge(sid) { socket.emit('send_challenge', {target_sid: sid}); showAlert("–í—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω..."); }
    let currentChallengeSid = null;
    socket.on('incoming_challenge', d => {
        currentChallengeSid = d.challenger_sid;
        document.getElementById('challenge-text').innerText = `${d.challenger_name} (${d.challenger_elo}) –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∞—Å!`;
        openModal('modal-challenge');
    });
    function respondChallenge(acc) { closeModal(); socket.emit('respond_challenge', {challenger_sid: currentChallengeSid, accepted: acc}); }

    function requestUndo() { socket.emit('request_undo'); showAlert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–æ–ø–µ—Ä–Ω–∏–∫—É..."); }
    socket.on('undo_requested', d => {
        document.getElementById('undo-text').innerText = `${d.requester} –ø—Ä–æ—Å–∏—Ç –≤–µ—Ä–Ω—É—Ç—å —Ö–æ–¥. –†–∞–∑—Ä–µ—à–∏—Ç—å?`;
        openModal('modal-undo');
    });
    function respondUndo(acc) { closeModal(); socket.emit('respond_undo', {accepted: acc}); }

    function spectate(gid) { socket.emit('spectate_game', {game_id: gid}); }
    
    socket.on('game_start', d => {
        // --- SPA: NO RELOAD ---
        gameState = d.state; myRole = d.role; prevLastMove = null; prevPasses = 0;
        tentativeMove = null;
        activeReviewIndex = -1;
        // Correct amIPlaying if we are one of the players
        if (d.role === 1 || d.role === 2 || d.role === 'challenger' || d.role === 'opponent') {
            amIPlaying = true;
        } else {
            amIPlaying = false; // spectator
        }
        
        // Initialize prevLastMove correctly to avoid phantom sound on reconnect
        if (d.state.last_move) {
            prevLastMove = d.state.last_move;
        } else {
            prevLastMove = null;
        }
        
        // Initialize prevPasses correctly
        if (d.state.consecutive_passes !== undefined) {
            prevPasses = d.state.consecutive_passes;
        } else {
            prevPasses = 0;
        }

        document.getElementById('confirm-move-btn').style.display = 'none';
        
        document.getElementById('chat-msgs').innerHTML = '';
        d.state.chat_history.forEach(addChatMsg);
        showScreen('screen-game');
        updateGameUI();
    });
    socket.on('setup_complete', d => { myRole = d.role; document.getElementById('modal-overlay').style.display = 'none'; });
    function pickColor(c) { socket.emit('setup_pick_color', {color: c}); }

    socket.on('update_game', s => { 
        // Reset busy flag
        isProcessingMove = false;
        
        if (s.last_move && (!prevLastMove || s.last_move.x !== prevLastMove.x || s.last_move.y !== prevLastMove.y)) {
            moveSound.currentTime = 0;
            moveSound.play().catch(e => console.log(e));
        }
        
        if (gameState && s.prisoners) {
            let diffB = s.prisoners[1] - gameState.prisoners[1];
            let diffW = s.prisoners[2] - gameState.prisoners[2];
            if (diffB > 0 || diffW > 0) {
                eatSound.currentTime = 0;
                eatSound.play().catch(e => console.log(e));
            }
        }
        
        if (s.phase === 'FINISHED' && s.is_resign) {
            // --- FIX: ONLY PLAY SOUND IF NOT ALREADY FINISHED ---
            if (!gameState || gameState.phase !== 'FINISHED') {
                dingSound.currentTime = 0;
                dingSound.play().catch(e => console.log(e));
            }
        }
        
        if (s.consecutive_passes > prevPasses) {
            if (s.phase !== 'FINISHED') {
                dingSound.currentTime = 0;
                dingSound.play().catch(e => console.log(e));
                if (myRole !== 0 && s.current_player === myRole) {
                    showAlert("–û–ø–ø–æ–Ω–µ–Ω—Ç –Ω–∞–∂–∞–ª –ø–∞—Å!");
                }
            }
        }
        prevPasses = s.consecutive_passes;
        prevLastMove = s.last_move;
        
        tentativeMove = null;
        document.getElementById('confirm-move-btn').style.display = 'none';

        gameState = s; 
        updateGameUI(); 
    });
    
    socket.on('update_dead_stones', l => { 
        if(gameState) { gameState.dead_stones = l; updateGameUI(); } 
    });
    
    socket.on('return_to_lobby', () => { 
        // This means the game room is fully disbanded for me or I was kicked
        amIPlaying = false; 
        document.getElementById('modal-setup').style.display = 'none';
        showScreen('screen-lobby'); 
        gameState=null; 
    });

    function leaveGame() {
        if(gameState && gameState.phase==='PLAYING' && (myRole===1||myRole===2)) {
            showScreen('screen-lobby');
            return;
        }
        socket.emit('leave_game');
        // Reset local playing flag if we really leave (finished game or spectator)
        amIPlaying = false;
    }
    
    function downloadSGF() {
        if(gameState && gameState.db_record_id) {
            window.location.href = `/download_sgf/${gameState.db_record_id}`;
        }
    }
    
    function stepActiveReview(delta) {
        if(!gameState || gameState.phase !== 'FINISHED') return;
        
        if(activeReviewIndex === -1) activeReviewIndex = gameState.full_history.length - 1;
        
        activeReviewIndex += delta;
        if(activeReviewIndex < 0) activeReviewIndex = 0;
        if(activeReviewIndex >= gameState.full_history.length) activeReviewIndex = gameState.full_history.length - 1;
        
        updateGameUI();
    }

    // Helper: Convert X,Y to Go coordinates (e.g. 0,0 -> A13)
    function getGoCoords(x, y) {
        const letters = "ABCDEFGHJKLMNOPQRST";
        if (x < 0 || x >= 13) return "?";
        const col = letters[x];
        const row = 13 - y;
        return `${col}${row}`;
    }

    function updateGameUI() {
        const p1 = gameState.players_info[1], p2 = gameState.players_info[2];
        
        const nb = document.querySelector('.player-block:nth-child(1) .clickable-name');
        nb.innerText = p1.name; nb.onclick = () => openProfile(p1.name);
        nb.onmousemove = (e) => showTooltip(e, p1.name);
        nb.onmouseleave = () => hideTooltip();
        
        const nw = document.querySelector('.player-block:nth-child(2) .clickable-name');
        nw.innerText = p2.name; nw.onclick = () => openProfile(p2.name);
        nw.onmousemove = (e) => showTooltip(e, p2.name);
        nw.onmouseleave = () => hideTooltip();

        document.getElementById('av-b').src = p1.avatar || DEF_AVATAR;
        document.getElementById('av-w').src = p2.avatar || DEF_AVATAR;
        
        if (gameState.phase === 'FINISHED' && gameState.winner_color) {
            if(gameState.winner_color === 1) nb.innerText += ' üèÜ';
            if(gameState.winner_color === 2) nw.innerText += ' üèÜ';
        }
        
        document.getElementById('game-title').innerText = `${p1.name} vs ${p2.name}`;
        
        let stateToShow = gameState;
        let isReview = false;
        if(gameState.phase === 'FINISHED' && activeReviewIndex !== -1 && activeReviewIndex < gameState.full_history.length) {
            stateToShow = gameState.full_history[activeReviewIndex];
            isReview = true;
        }
        
        document.getElementById('pris-b').innerText = stateToShow.prisoners[1];
        document.getElementById('pris-w').innerText = stateToShow.prisoners[2];
        
        const conf = gameState.confirmed_players || [];
        document.getElementById('check-b').innerHTML = conf.includes(1) ? '<span class="check-ok">‚úî</span>' : '';
        document.getElementById('check-w').innerHTML = conf.includes(2) ? '<span class="check-ok">‚úî</span>' : '';

        const turnDiv = document.getElementById('turn-display');
        turnDiv.className = 'turn-indic'; 
        const eloBox = document.getElementById('elo-msg-box');
        eloBox.innerHTML = ''; 
        const dlArea = document.getElementById('download-sgf-area');
        dlArea.style.display = 'none';
        const reviewBox = document.getElementById('immediate-replay-box');
        reviewBox.style.display = 'none';
        
        let mCount = isReview ? activeReviewIndex : gameState.move_count;
        let moveText = `–•–æ–¥: ${mCount}`;
        
        // Add Coordinates to text
        if (mCount > 0) {
            const relevantState = isReview ? gameState.full_history[mCount] : gameState;
            if (relevantState.last_move) {
                moveText += `, ${getGoCoords(relevantState.last_move.x, relevantState.last_move.y)}`;
            } else {
                moveText += `, –ü–∞—Å`;
            }
        }

        document.getElementById('pc-move-count').innerText = moveText;
        document.getElementById('mobile-move-count').innerText = moveText;

        document.getElementById('game-title').style.display = 'none';

        if (gameState.phase === 'FINISHED' && gameState.result_text) {
             turnDiv.innerText = `–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞ ${gameState.result_text}`;
             dlArea.style.display = 'block';
             reviewBox.style.display = 'block';
             
             let isWin = false;
             if (myRole !== 0) {
                 isWin = (myRole === gameState.winner_color);
                 turnDiv.classList.add(isWin ? 'result-win' : 'result-loss');
                 let delta = gameState.elo_delta;
                 let newElo = gameState.final_elos ? gameState.final_elos[myRole] : '???';
                 if (isWin) eloBox.innerHTML = `<span class="elo-msg-win">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ–≤—ã—Å–∏–ª—Å—è –Ω–∞ +${delta}! <span style="color:black">(${newElo})</span></span>`;
                 else eloBox.innerHTML = `<span class="elo-msg-loss">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ–Ω–∏–∑–∏–ª—Å—è –Ω–∞ -${delta} <span style="color:black">(${newElo})</span></span>`;
             } else {
                 turnDiv.style.backgroundColor = '#dcedc8';
             }
        } else {
             const cpName = (gameState.current_player === 1) ? p1.name : p2.name;
             const iconClass = (gameState.current_player === 1) ? 'stone-icon black' : 'stone-icon white';
             turnDiv.innerHTML = `–•–æ–¥: ${cpName} <div class="${iconClass}" style="vertical-align:middle; margin-left:5px;"></div>`;
             turnDiv.style.backgroundColor = '#eee';
        }
        
        const bPlay = document.getElementById('play-btns'), bScore = document.getElementById('score-btns');
        bPlay.style.display='none'; bScore.style.display='none';
        
        let scoreDiv = document.getElementById('scoring-details');
        scoreDiv.style.display = 'none';

        if (myRole===1 || myRole===2) {
            if(gameState.phase==='PLAYING') bPlay.style.display='block';
            else if(gameState.phase==='SCORING') {
                bScore.style.display='block';
                const scoreData = calcScoreGeneric(gameState.board, gameState.prisoners, gameState.dead_stones);
                scoreDiv.style.display = 'block';
                scoreDiv.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:5px;">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Å—á—ë—Ç:</div>
                    <div>‚óè –ß: <b>${scoreData.b_details.total}</b> (–¢:${scoreData.b_details.terr})</div>
                    <div>‚óã –ë: <b>${scoreData.w_details.total}</b> (–¢:${scoreData.w_details.terr})</div>
                    <div style="margin-top:5px; color:#00796b;">${scoreData.win === 1 ? "–ß" : "–ë"} +${scoreData.diff}</div>
                `;
                // ALWAYS DRAW MAP IN SCORING PHASE
                drawGenericBoard(liveCtx, gameState, scoreData.map);
                return; 
            }
        }
        
        const setupModal = document.getElementById('modal-setup');
        const wait = document.getElementById('wait-msg');
        
        if(gameState.phase==='SETUP') {
             if(myRole==='challenger') {
                 openModal('modal-setup');
             } else {
                 closeModal();
             }
            wait.style.display = (myRole==='opponent') ? 'block' : 'none';
            if(myRole==='opponent') wait.innerText = "–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç —Ü–≤–µ—Ç...";
        } else {
            wait.style.display='none';
        }
        
        // Use the helper here to draw the correct state
        drawGenericBoard(liveCtx, getCurrentRenderState(), null);
    }
    
    // Helper to determine what to draw on live board
    function getCurrentRenderState() {
        if (gameState && gameState.phase === 'FINISHED' && activeReviewIndex !== -1 && activeReviewIndex < gameState.full_history.length) {
            return gameState.full_history[activeReviewIndex];
        }
        return gameState;
    }

    // --- DRAWING ---
    function drawGenericBoard(ctx, state, terrMap) {
        ctx.fillStyle = '#DCB35C'; ctx.fillRect(0, 0, 700, 700);
        ctx.fillStyle = '#000'; ctx.font = '14px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.strokeStyle = '#000'; ctx.lineWidth = 1;
        const L = "ABCDEFGHJKLMNOPQRST";
        const offset = 22; const boardPixelSize = (BOARD_SIZE - 1) * CELL_SIZE; 
        
        for (let i = 0; i < BOARD_SIZE; i++) {
            let p = PADDING + i * CELL_SIZE;
            ctx.beginPath(); ctx.moveTo(p, PADDING); ctx.lineTo(p, PADDING+boardPixelSize); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(PADDING, p); ctx.lineTo(PADDING+boardPixelSize, p); ctx.stroke();
            let char = L[i], num = BOARD_SIZE - i;
            ctx.fillText(char, p, PADDING - offset); ctx.fillText(char, p, PADDING + boardPixelSize + offset);
            ctx.fillText(num, PADDING - offset, p); ctx.fillText(num, PADDING + boardPixelSize + offset, p);
        }
        ctx.fillStyle = '#000';
        [3,9,6].forEach(x=>[3,9,6].forEach(y=>{ctx.beginPath(); ctx.arc(PADDING+x*CELL_SIZE, PADDING+y*CELL_SIZE, 3, 0, Math.PI*2); ctx.fill();}));

        if(!state) return;

        for(let y=0; y<BOARD_SIZE; y++){
            for(let x=0; x<BOARD_SIZE; x++){
                let cx = PADDING + x * CELL_SIZE;
                let cy = PADDING + y * CELL_SIZE;

                if (terrMap && terrMap[y][x] !== 0) {
                    ctx.fillStyle = (terrMap[y][x] === 1) ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.7)';
                    ctx.fillRect(cx - 8, cy - 8, 16, 16);
                }
                let c = state.board[y][x];
                if(c!==0) drawStone(ctx, x, y, c);
                if(state.dead_stones && state.dead_stones.includes(`${x},${y}`)) drawDeadMark(ctx, x, y);
            }
        }
        
        // Ghost Stone Logic
        if(hoverStone && !isMobile() && gameState.phase === 'PLAYING' && state === gameState && myRole === state.current_player) {
            let cx = PADDING + hoverStone.x * CELL_SIZE;
            let cy = PADDING + hoverStone.y * CELL_SIZE;
            ctx.globalAlpha = 0.5;
            drawStone(ctx, hoverStone.x, hoverStone.y, myRole);
            ctx.globalAlpha = 1.0;
        }

        // Tentative Stone (Mobile)
        if(tentativeMove && isMobile() && gameState.phase === 'PLAYING') {
            let cx = PADDING + tentativeMove.x * CELL_SIZE;
            let cy = PADDING + tentativeMove.y * CELL_SIZE;
            ctx.globalAlpha = 0.6;
            drawStone(ctx, tentativeMove.x, tentativeMove.y, myRole);
            ctx.globalAlpha = 1.0;
            ctx.fillStyle = 'rgba(0,255,0,0.5)';
            ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill();
        }

        if(state.last_move) {
            let lm = state.last_move;
            let cx = PADDING+lm.x*CELL_SIZE, cy = PADDING+lm.y*CELL_SIZE;
            let col = state.board[lm.y][lm.x];
            if (col !== 0) {
                ctx.strokeStyle = (col===1)?'white':'black'; ctx.lineWidth=2; 
                ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.stroke(); 
                ctx.lineWidth=1; ctx.strokeStyle='#000';
            }
        }
    }
    
    function drawStone(ctx, x, y, c) {
        let cx=PADDING+x*CELL_SIZE, cy=PADDING+y*CELL_SIZE;
        ctx.beginPath(); ctx.arc(cx, cy, CELL_SIZE/2-2, 0, Math.PI*2);
        let g = ctx.createRadialGradient(cx-5, cy-5, 2, cx, cy, 15);
        if(c===1) { g.addColorStop(0,'#555'); g.addColorStop(1,'#000'); }
        else { g.addColorStop(0,'#fff'); g.addColorStop(1,'#ddd'); }
        ctx.fillStyle=g; ctx.fill();
    }
    function drawDeadMark(ctx, x, y) {
        let cx=PADDING+x*CELL_SIZE, cy=PADDING+y*CELL_SIZE;
        ctx.strokeStyle='red'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo(cx-10, cy-10); ctx.lineTo(cx+10, cy+10); ctx.moveTo(cx+10, cy-10); ctx.lineTo(cx-10, cy+10); ctx.stroke(); ctx.lineWidth=1;
    }

    liveCanvas.addEventListener('mouseleave', () => {
        if(!isMobile()) hoverStone = null;
        let map = null;
        if(gameState && gameState.phase === 'SCORING') {
            const r = calcScoreGeneric(gameState.board, gameState.prisoners, gameState.dead_stones);
            map = r.map;
        }
        
        let stateToDraw = getCurrentRenderState();
        if(stateToDraw) drawGenericBoard(liveCtx, stateToDraw, map);
    });

    function getBoardCoords(e, canvas) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const x = Math.round(((e.clientX - rect.left) * scaleX - PADDING)/CELL_SIZE);
        const y = Math.round(((e.clientY - rect.top) * scaleY - PADDING)/CELL_SIZE);
        return {x, y};
    }

    liveCanvas.addEventListener('mousemove', e => {
        if(isMobile()) return; 
        if(!gameState) return;
        
        let stateToDraw = getCurrentRenderState();
        
        // Calculate Map ON HOVER if scoring
        let map = null;
        if (gameState && gameState.phase === 'SCORING') {
            const r = calcScoreGeneric(gameState.board, gameState.prisoners, gameState.dead_stones);
            map = r.map;
        }

        // Ghost stone logic
        if (gameState.phase === 'PLAYING' && myRole === gameState.current_player && stateToDraw === gameState) {
             const c = getBoardCoords(e, liveCanvas);
             if(c.x>=0 && c.x<BOARD_SIZE && c.y>=0 && c.y<BOARD_SIZE) {
                if(gameState.board[c.y][c.x] === 0) {
                    hoverStone = {x: c.x, y: c.y};
                } else {
                    hoverStone = null;
                }
            } else {
                hoverStone = null;
            }
        } else {
            hoverStone = null;
        }
        
        drawGenericBoard(liveCtx, stateToDraw, map);
    });

    liveCanvas.addEventListener('click', e => {
        if(!gameState) return;
        const c = getBoardCoords(e, liveCanvas);
        
        if(c.x<0||c.x>=BOARD_SIZE||c.y<0||c.y>=BOARD_SIZE) return;
        
        if(gameState.phase==='PLAYING') {
            if(myRole!==gameState.current_player) return;
            
            if(isMobile()) {
                if(gameState.board[c.y][c.x] === 0) {
                    tentativeMove = {x: c.x, y: c.y};
                    document.getElementById('confirm-move-btn').style.display = 'block';
                    drawGenericBoard(liveCtx, gameState, null);
                }
            } else {
                tryMove(c.x, c.y);
            }

        } else if(gameState.phase==='SCORING' && (myRole===1||myRole===2)) {
            socket.emit('toggle_dead_stone', {key: `${c.x},${c.y}`});
        }
    });

    function submitMobileMove() {
        if(tentativeMove) {
            tryMove(tentativeMove.x, tentativeMove.y);
        }
    }

    function tryMove(x, y) {
        if(isProcessingMove) return; // Block double submit

        if(gameState.board[y][x]!==0) return;
        
        // Client side logic for preview
        let newB = gameState.board.map(r=>[...r]); newB[y][x]=myRole;
        let caps = getCaptures(newB, x, y, myRole);
        if(getLiberties(newB, x, y, myRole)===0 && caps.length===0) return showAlert("–°—É–∏—Ü–∏–¥ –∑–∞–ø—Ä–µ—â–µ–Ω!");
        if(gameState.ko_position && gameState.ko_position.x===x && gameState.ko_position.y===y) return showAlert("–ü—Ä–∞–≤–∏–ª–æ –ö–û!");
        caps.forEach(p=>newB[p.y][p.x]=0);
        let newPris={...gameState.prisoners}; newPris[myRole]+=caps.length;
        let ko=null; if(caps.length===1 && getLiberties(newB, x, y, myRole)===1 && getGroup(newB, x, y, myRole).length===1) ko={x:caps[0].x,y:caps[0].y};
        
        isProcessingMove = true; // Set busy flag
        socket.emit('make_move', {board: newB, prisoners: newPris, ko: ko, move_x: x, move_y: y});
    }

    function sendPass() { socket.emit('pass_move'); }
    function sendResign() { showConfirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–∞—Ç—å—Å—è?", () => socket.emit('resign')); }
    function resumeGame() { socket.emit('resume_game'); }
    function confirmScore() { 
        let r = calcScoreGeneric(gameState.board, gameState.prisoners, gameState.dead_stones); 
        socket.emit('confirm_score', {winner_color:r.win, diff:r.diff}); 
    }

    function sendChat() { const i=document.getElementById('chat-input'); if(i.value.trim()){socket.emit('send_message',{message:i.value}); i.value='';} }
    socket.on('new_message', m => addChatMsg(m));
    function addChatMsg(m) {
        const box = document.getElementById('chat-msgs');
        let iconClass = m.color === 1 ? "stone-icon black" : (m.color === 2 ? "stone-icon white" : "stone-icon spec");
        let moveInfo = (m.move !== undefined) ? `<span style="color:#999; font-size:0.8em; margin-right:4px;">[${m.move}]</span>` : '';
        
        box.innerHTML += `
        <div class="chat-row">
           <span class="chat-meta">
               ${moveInfo}
               <div class="${iconClass}"></div>
               <b>${m.user}: </b>
           </span>
           <span>${m.text}</span>
        </div>`;
        
        box.scrollTop = box.scrollHeight;
    }

    function getCaptures(b,x,y,c){let o=c===1?2:1,caps=[];[{x:x+1,y:y},{x:x-1,y:y},{x:x,y:y+1},{x:x,y:y-1}].forEach(n=>{if(n.x>=0&&n.x<13&&n.y>=0&&n.y<13&&b[n.y][n.x]===o){if(getLiberties(b,n.x,n.y,o)===0)caps.push(...getGroup(b,n.x,n.y,o));}});return caps;}
    function getGroup(b,gx,gy,c){let g=[],v=new Set(),s=[{x:gx,y:gy}];while(s.length){let{x,y}=s.pop(),k=`${x},${y}`;if(v.has(k))continue;v.add(k);g.push({x,y});[{x:x+1,y:y},{x:x-1,y:y},{x:x,y:y+1},{x:x,y:y-1}].forEach(n=>{if(n.x>=0&&n.x<13&&n.y>=0&&n.y<13&&b[n.y][n.x]===c)s.push(n);});}return g;}
    function getLiberties(b,gx,gy,c){let v=new Set(),s=[{x:gx,y:gy}],l=0;while(s.length){let{x,y}=s.pop(),k=`${x},${y}`;if(v.has(k))continue;v.add(k);[{x:x+1,y:y},{x:x-1,y:y},{x:x,y:y+1},{x:x,y:y-1}].forEach(n=>{if(n.x>=0&&n.x<13&&n.y>=0&&n.y<13){if(b[n.y][n.x]===0)l++;else if(b[n.y][n.x]===c&&!v.has(`${n.x},${n.y}`))s.push(n);}});}return l;}
    
    function calcScoreGeneric(board, prisoners, deadStones) {
        let b_pris = prisoners[1];
        let w_pris = prisoners[2];
        let komi = 6.5;
        let tb = board.map(r=>[...r]);
        deadStones.forEach(k=>{
            let[dx,dy]=k.split(',').map(Number), c=board[dy][dx];
            if(c===1) w_pris++; if(c===2) b_pris++; tb[dy][dx]=0;
        });
        let map = Array(13).fill(null).map(()=>Array(13).fill(0)); 
        let v = Array(13).fill(null).map(()=>Array(13).fill(false));
        let b_terr = 0, w_terr = 0;
        for(let y=0;y<13;y++){
            for(let x=0;x<13;x++){
                if(tb[y][x]===0 && !v[y][x]){
                    let r = getReg(tb,x,y,v);
                    if(r.o===1) { b_terr+=r.c; r.points.forEach(p => map[p.y][p.x] = 1); }
                    else if(r.o===2) { w_terr+=r.c; r.points.forEach(p => map[p.y][p.x] = 2); }
                }
            }
        }
        let b_total = b_pris + b_terr;
        let w_total = w_pris + w_terr + komi;
        return {
            win: b_total > w_total ? 1 : 2, 
            diff: Math.abs(b_total - w_total).toFixed(1),
            b_details: {total: b_total, terr: b_terr, pris: b_pris},
            w_details: {total: w_total, terr: w_terr, pris: w_pris, komi: komi},
            map: map
        };
    }
    function getReg(bd,sx,sy,v){
        let points = []; let iB=false, iW=false; let s=[{x:sx,y:sy}]; v[sy][sx]=true;
        while(s.length){
            let{x,y}=s.pop(); points.push({x,y});
            [{x:x+1,y:y},{x:x-1,y:y},{x:x,y:y+1},{x:x,y:y-1}].forEach(n=>{
                if(n.x>=0&&n.x<13&&n.y>=0&&n.y<13){
                    if(bd[n.y][n.x]===0 && !v[n.y][n.x]){ v[n.y][n.x]=true; s.push(n); }
                    else if(bd[n.y][n.x]===1) iB=true; else if(bd[n.y][n.x]===2) iW=true;
                }
            });
        }
        let o=0; if(iB&&!iW) o=1; if(!iB&&iW) o=2;
        return {c: points.length, o: o, points: points};
    }

    window.addEventListener('load', () => {
        const savedUser = localStorage.getItem('go_username');
        const savedPass = localStorage.getItem('go_password');
        if (savedUser && savedPass) {
            document.getElementById('username').value = savedUser;
            document.getElementById('password').value = savedPass;
            socket.emit('login', {username: savedUser, password: savedPass});
        }
    });
</script>
</body>
</html>
